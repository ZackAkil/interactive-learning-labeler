<html>

<head>
    <style>
        #box_drawer {
            border: red dashed 5px;
            position: relative;
            display: inline-block;
        }

        .box {
            border: blue solid 5px;
            position: absolute;
            pointer-events: none;
        }

        #current_drawing_box {
            border: rgb(242, 0, 255) dashed 5px;
        }

        .box_preview {
            height: 40px;
        }
    </style>

    <script src="https://unpkg.com/vue@3"></script>

</head>

<body>

    <div id="app">
        <h1>Box drawer sandbox</h1>

        <div id="box_drawer" @mousedown="mouseDown" @mouseup="mouseUp" @mousemove="mouseMove">
            <div class="box" v-for="box in boxes"
                :style="{ 'left': box.x + 'px' , 'top': box.y + 'px', 'width': box.width + 'px' , 'height': box.height + 'px'}">
            </div>
            <div id="current_drawing_box" class="box" v-if="current_drawing_box != null"
                :style="{ 'left': current_drawing_box.x + 'px' , 'top': current_drawing_box.y + 'px',  'width': current_drawing_box.width + 'px' , 'height': current_drawing_box.height + 'px'}">
            </div>
            <canvas id="canvas" height="800" width="800"></canvas>
        </div>

        <div>
            <p v-for="box in boxes">
                x:{{box.x}} y:{{box.y}} width:{{box.width}} height:{{box.height}} <button
                    @click="remove_box(box)">remove</button>
                <img class="box_preview" v-bind:src="box.image_data">
            </p>
        </div>
    </div>

</body>


<script>

    const BOUNDING_BOX_BORDER_WIDTH = 5;

    const app = Vue.createApp({
        data() {
            return {
                boxes: [],
                current_drawing_box: null,
                ctx: null
            }
        },
        methods: {
            mouseDown: function (e) {
                console.log('down', e)
                this.current_drawing_box = {
                    x: e.offsetX - BOUNDING_BOX_BORDER_WIDTH,
                    y: e.offsetY - BOUNDING_BOX_BORDER_WIDTH,
                    width: 0, height: 0
                }
            },

            mouseMove: function (e) {
                console.log('move')
                if (this.current_drawing_box) {
                    this.current_drawing_box.width = e.offsetX - this.current_drawing_box.x - BOUNDING_BOX_BORDER_WIDTH
                    this.current_drawing_box.height = e.offsetY - this.current_drawing_box.y - BOUNDING_BOX_BORDER_WIDTH
                }
            },

            mouseUp: function (e) {
                console.log('up', e)

                const width = e.offsetX - this.current_drawing_box.x - BOUNDING_BOX_BORDER_WIDTH
                const height = e.offsetY - this.current_drawing_box.y - BOUNDING_BOX_BORDER_WIDTH

                // if box has real width or height (not empty box)
                if ((width > 0) && (height > 0)) {

                    const image_data = this.ctx.getImageData(this.current_drawing_box.x + BOUNDING_BOX_BORDER_WIDTH,
                        this.current_drawing_box.y + BOUNDING_BOX_BORDER_WIDTH,
                        width, height)

                    this.boxes.push({
                        ...this.current_drawing_box,
                        height: height,
                        width: width,
                        image_data: imagedata_to_imageurl(image_data)
                    })
                }

                this.current_drawing_box = null
            },

            remove_box: function (box) {
                const id = this.boxes.indexOf(box)
                this.boxes.splice(id, 1)
            }
        },
        mounted: function () {
            console.log('mounted')

            var canvas = document.getElementById("canvas")
            this.ctx = canvas.getContext("2d")

            // draw image on canvas
            var img = new Image
            img.onload = function () {
                app.ctx.drawImage(img, 0, 0, 800, 800)
            };
            img.src = "road.jpeg"

        }
    }).mount('#app')



    function imagedata_to_imageurl(imagedata) {

        const canvas = document.createElement('canvas')
        canvas.width = imagedata.width
        canvas.height = imagedata.height
        const ctx = canvas.getContext("2d")
        ctx.putImageData(imagedata, 0, 0)
        return canvas.toDataURL()
    }


</script>

</html>